import time
import random
from sqlalchemy import create_engine, Column
from sqlalchemy.orm import sessionmaker
from pandas.core.frame import DataFrame
import pandas as pd
from loguru import logger

pd.set_option('display.max_columns', None)  # 显示最大列数
pd.set_option('display.width', None)  # 显示宽度
pd.set_option('colheader_justify', 'center')  # 显示居中
pd.set_option('max_colwidth', 200)


def udf_mac_o2h(data):
    s = str(hex(eval(str(data))))[2:].upper().rjust(12, '0')
    lt_s = list(s)
    lt_s.insert(10, '-')
    lt_s.insert(8, '-')
    lt_s.insert(6, '-')
    lt_s.insert(4, '-')
    lt_s.insert(2, '-')
    s = ''.join(lt_s)
    return s


def pg_insert_return_id(prop_info, tb_info, field_list, insert_values):
    field_list = ','.join(field_list)
    engine = create_engine(
        f"mysql+pymysql://{prop_info['user']}:{prop_info['password']}@{prop_info['host']}:{prop_info['port']}/{tb_info['database']}?charset=utf8",
        max_overflow=0, pool_size=5, pool_timeout=30, pool_recycle=-1)
    dbsession = sessionmaker(bind=engine)
    session = dbsession()
    session.execute(
        f"insert into {tb_info['tablename']} ({field_list}) values {insert_values}")
    session.commit()
    session.close()


def pandas_dataframe_to_string_sql_insert_values(df):
    # fs = ','.join(df.columns.values)
    lt = df.values.tolist()
    lt = [[str(i) for i in x] for x in lt]
    lt = ['(' + (','.join(x)) + ')' for x in lt]
    slt = ','.join(lt)
    return slt


dev_pla_list = [['41560000000232', '3534837070698072'],
                ['41560000000231', '3534837070698071'],
                ['41560000000230', '3534837070698070'],
                # ['41560000000229', '3534837070698069'],   # 新人民医院南门大厅1
                ['41560000000227', '3534837070698067'],
                # ['41560000000228', '3534837070698068'],   # 新人民医院东门大厅
                ['41560000000226', '3534837070698066'],
                ['43072121071430', '220927316919713'],
                ['41560000000048', '220927316919009'],
                ['41560000000021', '220927316919365'],
                ['41560000000155', '220927316918885'],
                ['41560000000118', '220927316919225'],
                ['41560000000213', '220927316919041'],
                ['41560000000061', '220927316918813'],
                ['41560000000221', '220927316919117'],
                ['41560000000130', '220927316918889'],
                ['41560000000026', '220927316918853'],
                ['41560000000068', '220927316918977'],
                ['43072121697883', '220927316919449'],
                ['43072121128843', '220927316919669'],
                ['41560000000015', '220927316918557'],
                ['41560000000199', '220927316919297'],
                ['43072121412417', '220927316919053'],
                ['43072121162656', '220927316919489'],
                ['41560000000235', '56557393131169041'],
                ['43072121093182', '220927316919701'],
                ['43072121321855', '220927316918577'],
                ['41560000000233', '3534837070698073'],
                ['43072121977062', '220927316918673'],
                ['41560000000216', '220927316918865'],
                ['41560000000046', '220927316919441'],
                ['43072121298755', '220927316919709'],
                ['41560000000175', '220927316919617'],
                ['41560000000134', '220927316919193'],
                ['43072121760567', '220927316918933'],
                ['41560000000188', '220927316919085'],
                ['43072121296032', '220927316919553'],
                ['43072121489432', '220927316918877'],
                ['41560000000182', '220927316919269'],
                ['41560000000205', '220927316919325'],
                ['41560000000107', '220927316919105'],
                ['41560000000209', '220927316919665'],
                ['43072125929714', '220927316919209'],
                ['41560000000236', '56557393131169042'],
                ['43072121317453', '220927316919521'],
                ['41560000000234', '56557393131169040'],
                ['41560000000122', '220927316918697'],
                ['41560000000022', '220927316918789'],
                ['41560000000183', '220927316919357'],
                ['43072121589585', '220927316919433'],
                ['43072121176085', '220927316919313'],
                ['43072121668304', '220927316918973'],
                ['41560000000237', '56557393131169043'],
                ['41560000000238', '56557393131169044'],
                ['43072121372744', '220927316919261'],
                ['41560000000225', '3534837070698065'],
                # ['41560000000150', '220927316193280'],    # 安凝乡张九台中学
                ['43072121283961', '220927316918589'],
                ['43072121789134', '220927316919345'],
                ['43072121867557', '220927316918985'],
                ['43072121134484', '220927316919673'],
                ['41560000000009', '220927316918689'],
                ['41560000000029', '220927316918729'],
                ['43072121264813', '220927316918849'],
                ['41560000000151', '220927316919549'],
                ['41560000000104', '220927316918757'],
                ['41560000000060', '220927316919649'],
                ['43072121261634', '220927316919621'],
                ['43072121194473', '220927316918769'],
                ['43072121396961', '220927316919493'],
                ['43072121551381', '220927316918993'],
                ['43072125764341', '220927316918657'],
                ['41560000000114', '3534837070699026'],
                ['43072121073903', '220927316918693'],
                ['41560000000056', '220927316919385'],
                ['41560000000038', '220927316918857'],
                ['41560000000193', '220927316919337'],
                ['41560000000051', '220927316919101'],
                ['41560000000131', '220927316919481'],
                ['41560000000171', '220927316919577'],
                ['43072121837610', '220927316919093'],
                ['41560000000212', '220927316919213'],
                ['41560000000129', '220927316919113'],
                ['41560000000092', '220927316919289'],
                ['43072121739236', '220927316919721'],
                ['41560000000039', '220927316919585'],
                ['41560000000115', '220927316918869'],
                ['41560000000081', '220927316918637'],
                ['41560000000069', '220927316918633'],
                ['41560000000133', '220927316918625'],
                ['41560000000088', '220927316919237'],
                ['41560000000004', '220927316919253'],
                ['43072121112512', '220927316918949'],
                ['43072121986673', '220927316919613'],
                ['43072121112203', '220927316919125'],
                ['43072121623694', '220927316919657'],
                ['41560000000106', '220927316918957'],
                ['41560000000137', '220927316918781'],
                ['41560000000010', '220927316918585'],
                ['43072121319203', '220927316919589'],
                ['41560000000035', '220927316918761'],
                ['41560000000080', '220927316919469'],
                ['43072121473714', '220927316919201'],
                ['41560000000173', '220927316919393'],
                ['43072121094932', '220927316919149'],
                ['43072121809828', '220927316919369'],
                ['43072121487825', '220927316919689'],
                ['41560000000054', '220927316918845'],
                ['43072121047116', '220927316919089'],
                ['43072121164183', '220927316919537'],
                ['43072121189262', '220927316919437'],
                ['41560000000201', '220927316919341'],
                ['41560000000207', '220927316919697'],
                ['41560000000166', '220927316918741'],
                ['43072121008572', '220927316919573'],
                ['43072121114288', '220927316919565'],
                ['43072121469172', '220927316919049'],
                ['43072121273502', '220927316918917'],
                ['43072121292473', '220927316918705'],
                ['43072121677927', '220927316918809'],
                ['43072121817743', '220927316919001'],
                ['43072121608855', '220927316919453'],
                ['43072121731544', '220927316918765'],
                ['41560000000049', '220927316919677'],
                ['41560000000027', '220927316918621'],
                ['41560000000140', '220927316919021'],
                ['43072121657942', '220927316919061'],
                ['41560000000161', '220927316918713'],
                ['41560000000218', '220927316919241'],
                ['41560000000169', '220927316919569'],
                ['41560000000032', '220927316918797'],
                ['41560000000156', '220927316919025'],
                ['41560000000072', '220927316918529'],
                ['41560000000042', '220927316919129'],
                ['43072121576045', '220927316919529'],
                ['41560000000109', '220927316918661'],
                ['43072121882283', '220927316918541'],
                ['43072121729253', '220927316919029'],
                ['43072121256181', '220927316918701'],
                ['41560000000066', '220927316919081'],
                ['41560000000034', '220927316919137'],
                ['41560000000222', '220927316918629'],
                ['41560000000006', '220927316918581'],
                ['43072121453730', '220927316918709'],
                ['43072121020584', '220927316919517'],
                ['41560000000073', '220927316918573'],
                ['41560000000076', '220927316918921'],
                ['41560000000126', '220927316919505'],
                ['41560000000196', '220927316919301'],
                ['43072121036168', '220927316918905'],
                ['43072121801992', '220927316918821'],
                ['43072121184644', '220927316918833'],
                ['41560000000206', '220927316919317'],
                ['41560000000024', '220927316919109'],
                ['41560000000147', '220927316919429'],
                ['41560000000116', '220927316918909'],
                ['43072121196811', '220927316919593'],
                ['41560000000002', '220927316918841'],
                ['43072121080815', '220927316919601'],
                ['41560000000192', '220927316919349'],
                ['41560000000062', '220927316919077'],
                ['41560000000195', '220927316919381'],
                ['41560000000097', '220927316918665'],
                ['41560000000152', '220927316919681'],
                ['43072121264200', '220927316918901'],
                ['43072121307948', '220927316918565'],
                ['43072121955230', '220927316918997'],
                ['41560000000020', '220927316919217'],
                ['41560000000203', '220927316919661'],
                ['41560000000001', '220927316918837'],
                ['43072121330449', '220927316919397'],
                ['41560000000019', '220927316919257'],
                ['41560000000013', '220927316919273'],
                ['41560000000111', '220927316919073'],
                ['43072121963528', '220927316918953'],
                ['41560000000059', '220927316919533'],
                ['41560000000077', '220927316918773'],
                ['41560000000036', '220927316919165'],
                ['41560000000200', '220927316919389'],
                ['41560000000018', '220927316919205'],
                ['43072121242788', '220927316919353'],
                ['41560000000017', '220927316919685'],
                ['41560000000105', '220927316918825'],
                ['43072121032072', '220927316919329'],
                ['43072121058559', '220927316918925'],
                ['43072121324125', '220927316919221'],
                ['41560000000190', '220927316918569'],
                ['41560000000179', '220927316919417'],
                ['41560000000011', '220927316919065'],
                ['43072121899906', '220927316919373'],
                ['41560000000057', '220927316919445'],
                ['41560000000086', '220927316919005'],
                ['41560000000079', '220927316919541'],
                ['41560000000145', '220927316918645'],
                ['43072121920906', '220927316919197'],
                ['41560000000078', '220927316918753'],
                ['43072121699101', '220927316919645'],
                ['43072121450116', '220927316919513'],
                ['41560000000103', '220927316918929'],
                ['41560000000033', '220927316919033'],
                ['43072121804883', '220927316919461'],
                ['43072121688446', '220927316919497'],
                ['43072121929024', '220927316919045'],
                ['41560000000031', '220927316918685'],
                ['43072121177758', '220927316918937'],
                ['41560000000108', '220927316918641'],
                ['41560000000210', '220927316919409'],
                ['41560000000065', '220927316918725'],
                ['43072121759191', '220927316918561'],
                ['43072121779187', '220927316919609'],
                ['41560000000095', '220927316919145'],
                ['43072121050259', '220927316919185'],
                ['41560000000093', '220927316919485'],
                ['41560000000136', '220927316919605'],
                ['41560000000117', '220927316918969'],
                ['41560000000003', '220927316919157'],
                ['43072121751656', '220927316919037'],
                ['41560000000211', '220927316918777'],
                ['41560000000165', '220927316918801'],
                ['41560000000112', '220927316919501'],
                ['41560000000037', '220927316919013'],
                ['41560000000135', '220927316918913'],
                ['41560000000075', '220927316918613'],
                ['41560000000044', '220927316919309'],
                ['41560000000214', '220927316918597'],
                ['43072121291315', '220927316918681'],
                ['41560000000208', '220927316919653'],
                ['41560000000123', '220927316918605'],
                ['41560000000158', '220927316919321'],
                ['43072121323312', '220927316918873'],
                ['43072121883131', '220927316918893'],
                ['43072121341245', '220927316919421'],
                ['41560000000045', '220927316919401'],
                ['41560000000124', '220927316918601'],
                ['43072121782003', '220927316919557'],
                ['41560000000040', '220927316919069'],
                ['41560000000186', '220927316918649'],
                ['41560000000084', '220927316919641'],
                ['43072121560784', '220927316918533'],
                ['41560000000050', '220927316918677'],
                ['41560000000023', '220927316918941'],
                ['41560000000041', '220927316918965'],
                ['43072121772398', '220927316918785'],
                ['41560000000138', '220927316919473'],
                ['43072121475214', '220927316919169'],
                ['41560000000043', '220927316918525'],
                ['41560000000098', '220927316918617'],
                ['43072121178358', '220927316919293'],
                ['41560000000132', '220927316919141'],
                ['43072121674235', '220927316918609'],
                ['41560000000028', '220927316919233'],
                ['41560000000025', '220927316918549'],
                ['43072121601219', '220927316919625'],
                ['41560000000215', '220927316919545'],
                ['41560000000204', '220927316919561'],
                ['41560000000184', '220927316919305'],
                ['41560000000090', '220927316918721'],
                ['41560000000189', '220927316919465'],
                ['43072121877051', '220927316919161'],
                ['41560000000128', '220927316918669'],
                ['41560000000198', '220927316919285'],
                ['41560000000191', '220927316919153'],
                ['41560000000220', '220927316919633'],
                ['43072121133132', '220927316919173'],
                ['41560000000007', '220927316919245'],
                ['41560000000121', '220927316918793'],
                ['43072121379122', '220927316919133'],
                ['41560000000194', '220927316919413'],
                ['41560000000091', '220927316919525'],
                ['41560000000110', '220927316918653'],
                ['43072121517780', '220927316919629'],
                ['41560000000053', '220927316919265'],
                ['43072121418209', '220927316918717'],
                ['43072121015054', '220927316919477'],
                ['43072121355748', '220927316918945'],
                ['43072121674703', '220927316919281'],
                ['43072121782420', '220927316919693'],
                ['43072121952760', '220927316919425'],
                ['43072121947964', '220927316918553'],
                ['43072121006458', '220927316919229'],
                ['43072121004733', '220927316919249'],
                ['43072121299351', '220927316918817'],
                ['43072121922441', '220927316919333'],
                ['43072121352705', '220927316919717'],
                ['43072121694036', '220927316919017'],
                ['43072121105943', '220927316918961'],
                ['43072121940405', '220927316919581'],
                ['43072121470079', '220927316918805'],
                ['43072121394398', '220927316919177'],
                ['43072121840488', '220927316919637'],
                ['43072121836211', '220927316919181'],
                ['43072121682148', '220927316919597'],
                ['43072121516913', '220927316918537'],
                ['43072121078915', '220927316918733'],
                ['43072121685543', '220927316918897'],
                ['43072121408059', '220927316919121'],
                ['43072121996842', '220927316918545'],
                ['43072121356344', '220927316918881'],
                ['43072121513856', '220927316918981'],
                ['43072121367183', '220927316918593']]

while 1:
    # 伪造数据
    try:
        t = int(time.time())
        t_x = int(t / 86400) * 86400 - 7200 * 3
        # 23点到5点不造数据
        if abs(t - t_x) <= 10800:
            continue
        t_start = t - 3600
        # print(t_start)

        cnt = random.randint(10, 20)
        # ap_list
        # 为数组中的设备每次插入一个mac，为1小时之内的数据，条数10到20条
        for i in range(len(dev_pla_list)):
            mac = random.randint(17592186044416, 281474959933440)
            # 随机mac string
            smac = udf_mac_o2h(mac)
            # 随机伪造数据条数
            cnt = random.randint(10, 20)
            # 随机时间
            time_list = random.sample(range(t_start, t), cnt)

            df1 = DataFrame({"time_on": time_list})
            df1["ap_mac"] = mac
            df1["str_ap_mac"] = smac
            df1["str_ap_mac"] = df1["str_ap_mac"].map(lambda x: '\'' + x + '\'')
            df1["time_update"] = df1["time_on"]
            df1["local_mac"] = dev_pla_list[i][1]
            df1["place_code"] = dev_pla_list[i][0]
            if i == 0:
                dfap = df1
            else:
                dfap = pd.concat([dfap, df1], axis=0, ignore_index=True)
        dfap["channel"] = 1
        dfap["encryption_type"] = 3
        dfap["time_off"] = 0
        dfap = dfap.sample(frac=1)
        # print(dfap)

        PGSQL_214 = {'host': '43.58.5.247', 'port': 3306, 'user': 'root', 'password': 'root123'}
        PGSQL_214_TRACK = {'database': 'police_center_db',
                           'tablename': 'co_ap_list'}  # 'schema': 'zhaoqing_duanzhou_db',

        pg_insert_return_id(PGSQL_214, PGSQL_214_TRACK,
                            ["time_on", "ap_mac", "str_ap_mac", "time_update", "local_mac",
                             "place_code", "channel", "encryption_type", "time_off"],
                            pandas_dataframe_to_string_sql_insert_values(dfap))
        logger.info("ap fake success")
        # print("ap fake success")

        # ele_fence
        # time_on       ap_mac          str_ap_mac      time_update    route_mac        place_code    signal  time_off
        for i in range(len(dev_pla_list)):
            mac = random.randint(17592186044416, 281474959933440)
            smac = udf_mac_o2h(mac)
            cnt = random.randint(10, 20)

            time_list = random.sample(range(t_start, t), cnt)

            df1 = DataFrame({"time_on": time_list})
            df1["mobile_mac"] = mac
            df1["str_mobile_mac"] = smac
            df1["str_mobile_mac"] = df1["str_mobile_mac"].map(lambda x: '\'' + x + '\'')
            df1["time_update"] = df1["time_on"]
            df1["router_mac"] = dev_pla_list[i][1]
            df1["place_code"] = dev_pla_list[i][0]

            s = random.sample(list(range(-80, -30)) * 2, cnt)

            s = [int(i) for i in s]
            dfs = DataFrame({"signal": s})
            df1 = pd.concat([df1, dfs], axis=1)
            # print(df1)
            if i == 0:
                dfele = df1
            else:
                dfele = pd.concat([dfele, df1], axis=0, ignore_index=True)
        dfele["time_off"] = 0
        dfele = dfele.sample(frac=1)
        # print(dfele)

        PGSQL_214 = {'host': '43.58.5.247', 'port': 3306, 'user': 'root', 'password': 'root123'}
        PGSQL_214_TRACK = {'database': 'police_center_db',
                           'tablename': 'co_ele_fence'}  # 'schema': 'zhaoqing_duanzhou_db',
        pg_insert_return_id(PGSQL_214, PGSQL_214_TRACK,
                            ["time_on", "mobile_mac", "str_mobile_mac", "time_update", "router_mac",
                             "place_code", "signal", "time_off"],
                            pandas_dataframe_to_string_sql_insert_values(dfele))
        # print("ele fack success!")
        logger.info("ele fack success!")
        # time.sleep(3600)
    except:
        logger.info("error")
        print("error")
    print("done")
    logger.info("done")
    time.sleep(20)
